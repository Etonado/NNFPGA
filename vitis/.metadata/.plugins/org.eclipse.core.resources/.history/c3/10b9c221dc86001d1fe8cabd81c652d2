/******************************************************************************
*
* Copyright (C) 2009 - 2014 Xilinx, Inc.  All rights reserved.
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
*
* Use of the Software is limited solely to applications:
* (a) running on a Xilinx device, or
* (b) that interact with a Xilinx device through a bus or interconnect.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
* XILINX  BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF
* OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* Except as contained in this notice, the name of the Xilinx shall not be used
* in advertising or otherwise to promote the sale, use or other dealings in
* this Software without prior written authorization from Xilinx.
*
******************************************************************************/

/*
 * helloworld.c: simple test application
 *
 * This application configures UART 16550 to baud rate 9600.
 * PS7 UART (Zynq) is not initialized by this application, since
 * bootrom/bsp configures it to baud rate 115200
 *
 * ------------------------------------------------
 * | UART TYPE   BAUD RATE                        |
 * ------------------------------------------------
 *   uartns550   9600
 *   uartlite    Configurable only in HW design
 *   ps7_uart    115200 (configured by bootrom/bsp)
 */

#include <stdio.h>
#include "platform.h"
#include "xil_printf.h"
#include "xil_io.h"
#include "xbram.h"
#include "xparameters.h"
#include <unistd.h>
#include "myInclude.h"

#include "xnn_inference.h"
#include "xnn_inference_hw.h"


#define N_INPUTS 576
#define BRAM(A) ((volatile u32*)px_config->MemBaseAddress)[A]

float img0[N_INPUTS] = {0.5294117647058824,0.5372549019607843,0.5450980392156862,0.5529411764705883,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5686274509803921,0.5686274509803921,0.5686274509803921,0.5686274509803921,0.5647058823529412,0.5607843137254902,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5607843137254902,0.5568627450980392,0.5607843137254902,0.5568627450980392,0.5529411764705883,0.5294117647058824,0.5294117647058824,0.5372549019607843,0.5254901960784314,0.5058823529411764,0.5254901960784314,0.5333333333333333,0.5411764705882353,0.5490196078431373,0.5568627450980392,0.5568627450980392,0.5607843137254902,0.5568627450980392,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5607843137254902,0.5607843137254902,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5686274509803921,0.5686274509803921,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5607843137254902,0.5607843137254902,0.5450980392156862,0.5529411764705883,0.5568627450980392,0.5333333333333333,0.5294117647058824,0.5411764705882353,0.5647058823529412,0.5294117647058824,0.5333333333333333,0.5411764705882353,0.5490196078431373,0.5568627450980392,0.5568627450980392,0.5607843137254902,0.5568627450980392,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5647058823529412,0.5686274509803921,0.5686274509803921,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5647058823529412,0.5607843137254902,0.5607843137254902,0.5411764705882353,0.5372549019607843,0.5490196078431373,0.5215686274509804,0.5647058823529412,0.5215686274509804,0.5294117647058824,0.5294117647058824,0.5372549019607843,0.5411764705882353,0.5490196078431373,0.5568627450980392,0.5568627450980392,0.5568627450980392,0.5568627450980392,0.5568627450980392,0.5529411764705883,0.5568627450980392,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5607843137254902,0.5647058823529412,0.5647058823529412,0.5607843137254902,0.5450980392156862,0.5490196078431373,0.5176470588235295,0.5294117647058824,0.6313725490196078,0.5647058823529412,0.5137254901960784,0.5254901960784314,0.5254901960784314,0.5294117647058824,0.5333333333333333,0.5411764705882353,0.5450980392156862,0.5529411764705883,0.5529411764705883,0.5490196078431373,0.5490196078431373,0.5490196078431373,0.5490196078431373,0.5529411764705883,0.5529411764705883,0.5568627450980392,0.5529411764705883,0.5490196078431373,0.5529411764705883,0.5529411764705883,0.5529411764705883,0.5529411764705883,0.5568627450980392,0.5568627450980392,0.5568627450980392,0.5294117647058824,0.5333333333333333,0.5450980392156862,0.5450980392156862,0.4588235294117647,0.3803921568627451,0.5019607843137255,0.2784313725490196,0.5176470588235295,0.5215686274509804,0.5254901960784314,0.5333333333333333,0.5372549019607843,0.5411764705882353,0.5450980392156862,0.5490196078431373,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5450980392156862,0.5450980392156862,0.5450980392156862,0.5411764705882353,0.5450980392156862,0.5450980392156862,0.5450980392156862,0.5490196078431373,0.5490196078431373,0.5450980392156862,0.5372549019607843,0.5333333333333333,0.5215686274509804,0.5137254901960784,0.44313725490196076,0.4117647058823529,0.3215686274509804,0.2627450980392157,0.24705882352941178,0.5098039215686274,0.5176470588235295,0.5254901960784314,0.5333333333333333,0.5333333333333333,0.5333333333333333,0.5372549019607843,0.5372549019607843,0.5333333333333333,0.5333333333333333,0.5372549019607843,0.5372549019607843,0.5372549019607843,0.5372549019607843,0.5372549019607843,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5411764705882353,0.5294117647058824,0.5176470588235295,0.5137254901960784,0.4549019607843137,0.4666666666666667,0.4627450980392157,0.3843137254901961,0.2235294117647059,0.16470588235294117,0.24705882352941178,0.4980392156862745,0.5098039215686274,0.5254901960784314,0.5294117647058824,0.5294117647058824,0.5254901960784314,0.5254901960784314,0.5294117647058824,0.5333333333333333,0.5333333333333333,0.5372549019607843,0.5372549019607843,0.5333333333333333,0.5333333333333333,0.5372549019607843,0.5411764705882353,0.5372549019607843,0.5372549019607843,0.5372549019607843,0.5411764705882353,0.5411764705882353,0.5333333333333333,0.5176470588235295,0.5019607843137255,0.42745098039215684,0.43529411764705883,0.44313725490196076,0.33725490196078434,0.19607843137254902,0.5019607843137255,0.49019607843137253,0.2980392156862745,0.49019607843137253,0.5058823529411764,0.5137254901960784,0.5176470588235295,0.5215686274509804,0.5215686274509804,0.5215686274509804,0.5294117647058824,0.5333333333333333,0.5254901960784314,0.5333333333333333,0.5450980392156862,0.5411764705882353,0.5254901960784314,0.5294117647058824,0.5450980392156862,0.5372549019607843,0.5294117647058824,0.5529411764705883,0.5254901960784314,0.5411764705882353,0.5372549019607843,0.5098039215686274,0.41568627450980394,0.37254901960784315,0.3215686274509804,0.23921568627450981,0.15294117647058825,0.49019607843137253,0.4980392156862745,0.48627450980392156,0.4588235294117647,0.49019607843137253,0.5058823529411764,0.5176470588235295,0.5176470588235295,0.5176470588235295,0.5176470588235295,0.5215686274509804,0.5254901960784314,0.5333333333333333,0.49411764705882355,0.47058823529411764,0.48627450980392156,0.5215686274509804,0.5411764705882353,0.5372549019607843,0.5294117647058824,0.5294117647058824,0.5490196078431373,0.5176470588235295,0.5372549019607843,0.5215686274509804,0.4588235294117647,0.3568627450980392,0.29411764705882354,0.2196078431372549,0.1607843137254902,0.12941176470588237,0.48627450980392156,0.4823529411764706,0.4627450980392157,0.4666666666666667,0.43137254901960786,0.49411764705882355,0.5098039215686274,0.5176470588235295,0.5176470588235295,0.5215686274509804,0.5215686274509804,0.5215686274509804,0.5294117647058824,0.5411764705882353,0.5333333333333333,0.5294117647058824,0.5294117647058824,0.5294117647058824,0.5333333333333333,0.5372549019607843,0.5411764705882353,0.5372549019607843,0.5372549019607843,0.5411764705882353,0.5176470588235295,0.4,0.25882352941176473,0.17254901960784313,0.13725490196078433,0.43529411764705883,0.45098039215686275,0.45098039215686275,0.4549019607843137,0.4745098039215686,0.45098039215686275,0.4117647058823529,0.4196078431372549,0.49019607843137253,0.5098039215686274,0.5215686274509804,0.5176470588235295,0.5176470588235295,0.5215686274509804,0.5215686274509804,0.5254901960784314,0.5215686274509804,0.5254901960784314,0.5333333333333333,0.5333333333333333,0.5294117647058824,0.5294117647058824,0.5294117647058824,0.5254901960784314,0.5333333333333333,0.5254901960784314,0.43137254901960786,0.396078431372549,0.2784313725490196,0.4666666666666667,0.4588235294117647,0.4470588235294118,0.42745098039215684,0.4117647058823529,0.44313725490196076,0.4235294117647059,0.4117647058823529,0.4,0.3764705882352941,0.4117647058823529,0.4823529411764706,0.5058823529411764,0.5176470588235295,0.5137254901960784,0.5137254901960784,0.5137254901960784,0.5137254901960784,0.5176470588235295,0.5215686274509804,0.5215686274509804,0.5215686274509804,0.5215686274509804,0.5254901960784314,0.5333333333333333,0.5333333333333333,0.5254901960784314,0.4980392156862745,0.4,0.10980392156862745,0.1843137254901961,0.4823529411764706,0.4549019607843137,0.4666666666666667,0.43137254901960786,0.4117647058823529,0.4117647058823529,0.40784313725490196,0.39215686274509803,0.37254901960784315,0.3607843137254902,0.37254901960784315,0.3568627450980392,0.4745098039215686,0.5019607843137255,0.5137254901960784,0.5098039215686274,0.5098039215686274,0.5098039215686274,0.5058823529411764,0.5058823529411764,0.5098039215686274,0.5176470588235295,0.5215686274509804,0.5176470588235295,0.5098039215686274,0.5098039215686274,0.5137254901960784,0.5137254901960784,0.1568627450980392,0.20392156862745098,0.4980392156862745,0.48627450980392156,0.4666666666666667,0.4470588235294118,0.44313725490196076,0.4196078431372549,0.403921568627451,0.403921568627451,0.39215686274509803,0.3803921568627451,0.34509803921568627,0.36470588235294116,0.34509803921568627,0.34901960784313724,0.4627450980392157,0.49411764705882355,0.5098039215686274,0.5058823529411764,0.5058823529411764,0.5098039215686274,0.5058823529411764,0.5058823529411764,0.5058823529411764,0.5058823529411764,0.5058823529411764,0.5176470588235295,0.5254901960784314,0.5254901960784314,0.5176470588235295,0.5098039215686274,0.5137254901960784,0.48627450980392156,0.49019607843137253,0.4666666666666667,0.4470588235294118,0.43529411764705883,0.42745098039215684,0.403921568627451,0.3843137254901961,0.4,0.35294117647058826,0.33725490196078434,0.34901960784313724,0.3176470588235294,0.32941176470588235,0.35294117647058826,0.4470588235294118,0.4823529411764706,0.5019607843137255,0.5019607843137255,0.5019607843137255,0.5058823529411764,0.5058823529411764,0.5019607843137255,0.4980392156862745,0.4980392156862745,0.5019607843137255,0.5098039215686274,0.5098039215686274,0.5098039215686274,0.5098039215686274,0.5137254901960784,0.4980392156862745,0.49019607843137253,0.47843137254901963,0.45098039215686275,0.4470588235294118,0.45098039215686275,0.403921568627451,0.4,0.3843137254901961,0.3764705882352941,0.34901960784313724,0.3411764705882353,0.3137254901960784,0.3215686274509804,0.30980392156862746,0.3254901960784314,0.4392156862745098,0.4745098039215686,0.48627450980392156,0.5019607843137255,0.5019607843137255,0.5098039215686274,0.4980392156862745,0.4980392156862745,0.5019607843137255,0.5019607843137255,0.5098039215686274,0.5098039215686274,0.5058823529411764,0.5058823529411764,0.5058823529411764,0.4980392156862745,0.49019607843137253,0.47843137254901963,0.45098039215686275,0.44313725490196076,0.43529411764705883,0.4196078431372549,0.4117647058823529,0.39215686274509803,0.39215686274509803,0.3607843137254902,0.3333333333333333,0.3058823529411765,0.30196078431372547,0.30980392156862746,0.30980392156862746,0.3176470588235294,0.4235294117647059,0.4588235294117647,0.47843137254901963,0.49411764705882355,0.4980392156862745,0.5058823529411764,0.4980392156862745,0.4980392156862745,0.49411764705882355,0.49411764705882355,0.5019607843137255,0.5058823529411764,0.4980392156862745,0.5019607843137255,0.5019607843137255,0.49019607843137253,0.4823529411764706,0.47058823529411764,0.4470588235294118,0.44313725490196076,0.4392156862745098,0.4235294117647059,0.4117647058823529,0.396078431372549,0.3843137254901961,0.35294117647058826,0.3215686274509804,0.2980392156862745,0.29411764705882354,0.3058823529411765,0.30196078431372547,0.30980392156862746};


XBram x_bram;
XBram_Config *px_config;

XNn_inference neuralNet;
XNn_inference_Config* neuralNetConf;


int main()
{
    init_platform();

    px_config = XBram_LookupConfig(XPAR_BRAM_0_DEVICE_ID);
    int x_status = XBram_CfgInitialize(&x_bram, px_config, px_config->CtrlBaseAddress);

    neuralNetConf = XNn_inference_LookupConfig(XPAR_XNN_INFERENCE_0_DEVICE_ID);
    x_status = XNn_inference_CfgInitialize(&neuralNet, neuralNetConf);
    x_status = XNn_inference_Initialize(&neuralNet, XPAR_XNN_INFERENCE_0_DEVICE_ID);

	for (int i = 0; i < N_INPUTS; i++) {
		BRAM(i) = *(u32 *)(&(img0[i]));
	}


	while(!XNn_inference_IsIdle(&neuralNet)){xil_printf("Hello\n");}
	xil_printf("Start");
	XNn_inference_Start(&neuralNet);
	xil_printf("Started");
	while(!XNn_inference_IsDone(&neuralNet)){}

	int ret = (int)XNn_inference_Get_return(&neuralNet);

	xil_printf("%d",ret);


}
